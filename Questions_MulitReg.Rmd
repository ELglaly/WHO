---
title: "Mulit"
author: "Sherif Shawashen"
date: "2024-10-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load the dataset and clean the data using omit 
# function to change the names of data fram to lowercase and "." to "_" so we can access it easily
# link for gsub=> https://stackoverflow.com/questions/11776287/remove-pattern-from-string-with-gsub

```{r cars}
WHO <- read.csv("Life Expectancy Data.csv")

LowerAndDotReplace <- function(data_frame_pass){
      # convert to lowercase
      names(data_frame_pass) <- tolower(names(data_frame_pass))
      # conver . with _ 
      names(data_frame_pass) <- gsub("\\.", "_", names(data_frame_pass))

  return(data_frame_pass)
}

WHO <-na.omit(WHO)

WHO <- LowerAndDotReplace(WHO)

class
names(WHO)
```

##  Does the countryâ€™s GDP, Schooling, status or Total expenditure affect life expectancy?
```{r}
#check the class of the status column
class(WHO$status)
# check if there is other values rather than "Developing" "Developed" 
unique(WHO$status)

```


```{r}

multi_model_gdp_status <- lm(life_expectancy ~ gdp + status + schooling + total_expenditure , data = WHO)
summary(multi_model_gdp_status)

```
# coefficients:

1- (**Intercept**): The model predicts that when all variables GDP, schooling, and total expenditure are zero and statusis Developed (baseline) , life expectancy equals 45.67 years. and for **intercept** The p-value is less than 5% , which indicates that this estimate is statistically significant.

2- GDP: The model shows that for each unit increase in GDP, life expectancy increases by 8.576e-05 years, holding all other factors constant and status is Developed (baseline). The  p-value less than 5% indicates a statistically significant relationship between GDP and life expectancy and we can reject null hypothesis.

3- status (Developing) -1.465e+00 :  is This is the difference in the intercept between "Developed" and "Developing", holding all other variables GDP, schooling, and total expenditure zero. The p-value is 0.0041, which shows this estimate is statistically significant.

schooling: The model shows that for each unit increase in schooling, life expectancy increases by 2.041e+00 years, holding all other factors constant and status = "Developed" . The v p-value (less than %5) indicates a statistically significant relationship between life expectency and Schooling.

total_expenditure: The model Shows that for each unit increase in total expenditure, the life expectancy decreases by 5.722e-02 years. However, the p-value of 0.3857 higher than 5% which means  that this effect is not statistically significant we can not reject null hypothesis.

#Residual standard error:
1- Residual standard error is 5.942 This is a measure of the variability of the residuals, which means that the Residual are not spread out in the model
2- Multiple R-squared: 0.5449 This means that the model explains 54.49% of the variance in life expectency, wich is not very high


# Multicollinearity for the multi_model_gdp_status model

```{r}


# add status_numeric as anew cloumns becuase cor cunctio use only numerical data
WHO$status_numeric <- ifelse(WHO$status == "Developed", 1, 0)
class(WHO$status_numeric)

cor( WHO[,c("gdp" ,"schooling" , "total_expenditure", "status_numeric")])

# Model
cor( WHO[,c("gdp", "total_expenditure", "status_numeric")])

#cor.test(WHO$gdp,WHO$schooling)

```
1- Form the corelation matrix above we can see that GDP and schooling is corelated as cor estmite equals 0.4679470 so We will remove the of them but base on the cor estimate between total_expenditure and GDP is less than schooling and total_expenditure we will reomve schooling from the model.

2-similartiy, for the status we can see that GDP and status is corelated as cor estmates equals 0.4848010 so we will reomve status_numericfrom the model

#multi_model_gdp_status after removing corelated factors

```{r}

multi_model_gdp_status <- lm(life_expectancy ~ gdp + total_expenditure , data = WHO)
summary(multi_model_gdp_status)
```
what we can see that the Multiple R-squared: 0.2041 which was 0.5449 before removing removing corelated factors which means that the model explains 20.41% of the variance in life expectency, wich is not very high.

# Interactions Between  GDP and total_expenditure

```{r}
interaction_model_GDP_total_expenditure <- lm(WHO$life_expectancy ~ WHO$total_expenditure * WHO$gdp)
summary(interaction_model_GDP_total_expenditure)

```
# coefficients:

1- (**Intercept**): The model predicts that when all variables GDP, and total expenditure are zero  , life expectancy equals 6.435e+01 years. and for **intercept** The p-value is less than 5% , which indicates that this estimate is statistically significant.

2- GDP: The model shows that for each unit increase in GDP, life expectancy increases by5.230e-01 years, holding all other factors constant. The  p-value less than 5% indicates a statistically significant relationship between GDP and life expectancy and we can reject null hypothesis.


WHO$total_expenditure:WHO$gdp : The model shows that the effect of gdp on the life expectency changes by -1.795e-05 when total_expenditure increases by one unit. the p-values indictes that relationship between GDP and life expectancy  varies depending on the level of total expenditure.


# Visualizing the Interaction
```{r}

ggplot(WHO, aes(x = gdp, y = life_expectancy, color = cut(total_expenditure, 5))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```
# Visualizing the Interaction based on the value of  total total_expenditure
```{r}

WHO$expenditure_group <- cut(WHO$total_expenditure, 5)

ggplot(WHO, aes(x = gdp, y = life_expectancy, color = expenditure_group)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)+
  facet_wrap(~ expenditure_group)
```


# Visualizing the Interaction based on the stauts of the country and expenditure_group
```{r}


ggplot(WHO, aes(x = gdp, y = life_expectancy, color = expenditure_group)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ status + expenditure_group)
```

# confedence interval for for coefficient the multi_model_gdp_status Model

```{r}

 confint(multi_model_gdp_status)

```

1- We can see that the confidence interval for the **intercept** ranges from 6.420144e+01 6.630828e+01. This means that we can be 95% confident that the true value of the intercept lies within this range.

2- Similarly, the confidence interval for gdp is between 2.910889e-04 3.583137e-04, indicating that we can be 95% confident that the true effect of gdp on life expectency falls within this interval.

3- according to total_expenditure, the confidence interval for total_expenditure is between 2.083665e-01 5.438757e-01, indicating that we can be 95% confident that the true effect of total_expenditure on life expectency falls within this interval.

Since the confidence intervals for both the intercept and GDP and total_expenditure do not include zero, we can reject the null hypothesis. which suggests that there is a statistically significant relationship between (gdp , total_expenditure) and life expectency.

# visualizing confedence interval for for coefficient the multi_model_gdp_status Model


```{r }

visualize_coefficient_CI <- function(function_model) {
  # Create data frame for coefficients
  df_coefficient <- as.data.frame(confint(function_model))
  df_coefficient$coefficient <- rownames(df_coefficient)
  df_coefficient$estimate <- coef(function_model)

  ggplot(df_coefficient, aes(x = coefficient, y = estimate)) +  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin = `2.5 %`, ymax = `97.5 %`), width = 0.2) +
    labs(title = "Coefficients and Their Confidence Intervals", 
         x = "Coefficient", 
         y = "Estimate")
}
visualize_coefficient_CI(multi_model_gdp_status)

```

# visualizing multi_model_gdp_status Model
```{r}

visualize_multiple_regression <- function(dependent_name, independent_vars, independent_names) {
  
  ggplot(WHO, aes_string(x = independent_vars, y = dependent_name)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE, color = "blue") +
    theme_minimal() +
    labs(title = paste("Visualizing : ", dependent_name, " vs ", independent_names),
         x = independent_names,
         y = dependent_name)
}

# Example usage
visualize_multiple_regression("life_expectancy", 
                               "gdp + total_expenditure", 
                               "GDP && Total Expenditure")
     

```
# visualzing the residuals 

```{r }
library(ggplot2)

# Function to visualize residuals
visualize_residuals <- function(dependent_name, independent_vars, independent_names, data_model) {
  
  WHO$predicted <- predict(data_model)
 
  # Plotting
  ggplot(WHO, aes_string(x = independent_vars, y = dependent_name)) +
    geom_point() +
    geom_segment(aes_string(xend = independent_vars, yend = "predicted"), color = "red") + 
    geom_smooth(method = "lm", se = FALSE, color = "blue")+  
    theme_minimal() + 
    labs(title = paste("Visualizing Residuals: ", dependent_name, " vs ", independent_names),
         x = independent_names,
         y = "Residuals")
}

visualize_residuals("life_expectancy",  "gdp + total_expenditure", "GDP per Capita && total Expenditure ",multi_model_gdp_status )



```




```{r }

visualize_confidence_interval_multiple <- function(function_model, dependent_name, independent_vars, independent_names) {
  
  new_data <- data.frame(matrix(ncol = length(independent_vars), nrow = 200))
  colnames(new_data) <- independent_vars
  for (i in 1:length(independent_vars)) {
    new_data[[independent_vars[i]]] <- seq(min(WHO[[independent_vars[i]]]), 
                                             max(WHO[[independent_vars[i]]]), 
                                             length.out = 200)

  }
  
  # Predict with confidence intervals
  CI_95 <- predict(function_model, newdata = new_data, interval = "confidence", level = 0.95)
  
  new_data$fit <- CI_95[, "fit"]
  new_data$up <- CI_95[, "upr"]
  new_data$down <- CI_95[, "lwr"]
  
   colnames_format= paste(independent_vars[1] ," + ",independent_vars[2])

  
  ggplot(new_data, aes_string(x = colnames_format  , y = "fit")) +  
    geom_line(color = "red") + 
    geom_ribbon(aes(ymin = down, ymax = up), alpha = 0.3, fill = "green") + 
    theme_minimal() +
    labs(title = paste("95% Confidence Interval for ", independent_names, " vs ", dependent_name),
         x = independent_names,
         y = dependent_name) 
}

visualize_confidence_interval_multiple(multi_model_gdp_status, "life_expectancy", 
                                        c("gdp", "total_expenditure"), 
                                        "GDP & total Expenditure ")

```


